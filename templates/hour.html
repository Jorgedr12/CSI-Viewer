{% extends "_base.html" %}

{% block title %}Análisis {{ display_day }} {{ hour }}{% endblock %}

{% block content %}
<style>
    .modal-nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(0, 0, 0, 0.4);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        z-index: 1056; 
    }
    .modal-nav-btn:hover {
        background-color: rgba(0, 0, 0, 0.7);
    }
    .modal-nav-btn.prev {
        left: 15px;
    }
    .modal-nav-btn.next {
        right: 15px;
    }
</style>

<div class="top-bar">
    <a href="{{ url_for('show_day', day=day) }}" class="csi-btn"><i class="fas fa-arrow-left me-2"></i>VOLVER AL DÍA</a>
    <a href="{{ url_for('logout') }}" class="csi-btn"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a>
</div>

<h2 class="csi-subtitle mb-4">
    ANALYZING EVIDENCE: {{ display_day }} - {{ hour }} <span class="text-info">{{ time_range }}</span>
</h2>

<div class="row g-3 row-cols-1 row-cols-sm-3 row-cols-md-5">
    {% for img in images %}
    <div>
        <div class="csi-panel">
            <img src="{{ url_for('serve_image_path', filepath=day+'/'+hour+'/normal/'+img) }}" alt="Miniatura"
                 data-bs-toggle="modal" data-bs-target="#imageModal" data-index="{{ loop.index0 }}">
            <div class="csi-panel-title">
                <i class="fas fa-camera me-2"></i>
                {{ img.split('.')[0].replace('m','m ').replace('s','s') }}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center position-relative">
                <button class="modal-nav-btn prev" id="modal-prev-btn"><i class="fas fa-chevron-left"></i></button>
                <img src="" class="img-fluid" style="max-height: 85vh;" alt="Imagen ampliada" id="modal-image">
                <button class="modal-nav-btn next" id="modal-next-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const imageModal = document.getElementById('imageModal');
    
    let imagesOnCurrentPage = {{ images|tojson }};
    let currentPage = {{ page }};
    let totalPages = {{ total_pages }};
    let currentIndexInPage = 0;

    const normalBaseUrl = "{{ url_for('serve_image_path', filepath=day+'/'+hour+'/normal') }}/";
    const apiBaseUrl = `{{ url_for('get_images_for_hour', day=day, hour=hour) }}`;

    if (imageModal) {
        const modalTitle = imageModal.querySelector('.modal-title');
        const modalImage = document.getElementById('modal-image');
        const prevButton = document.getElementById('modal-prev-btn');
        const nextButton = document.getElementById('modal-next-btn');

        function formatName(name) {
            return name.replace('.jpg','').replace('m','m ').replace('s','s');
        }
        
        function updateModal(indexInPage) {
            currentIndexInPage = indexInPage;
            const imageName = imagesOnCurrentPage[indexInPage];
            
            modalTitle.textContent = `[ ${formatName(imageName)} ]`;
            modalImage.src = normalBaseUrl + imageName;
        }

        async function loadPage(pageNumber, position = 'start') {
            modalImage.style.opacity = 0.5;
            try {
                const response = await fetch(`${apiBaseUrl}?page=${pageNumber}`);
                if (!response.ok) throw new Error('Error en API');
                
                const data = await response.json();
                imagesOnCurrentPage = data.images;
                currentPage = data.currentPage;
                totalPages = data.totalPages;

                const newIndex = position === 'start' ? 0 : imagesOnCurrentPage.length - 1;
                updateModal(newIndex);
            } catch (error) {
                console.error("Error:", error);
            } finally {
                modalImage.style.opacity = 1;
            }
        }

        function navigateNext() {
            if (currentIndexInPage >= imagesOnCurrentPage.length - 1) {
                if (currentPage < totalPages) loadPage(currentPage + 1, 'start');
            } else {
                updateModal(currentIndexInPage + 1);
            }
        }

        function navigatePrev() {
            if (currentIndexInPage <= 0) {
                if (currentPage > 1) loadPage(currentPage - 1, 'end');
            } else {
                updateModal(currentIndexInPage - 1);
            }
        }

        imageModal.addEventListener('show.bs.modal', event => {
            const index = parseInt(event.relatedTarget.getAttribute('data-index'));
            updateModal(index);
        });

        document.addEventListener('keydown', (event) => {
            if (!imageModal.classList.contains('show')) return;
            if (event.key === 'ArrowRight') navigateNext();
            if (event.key === 'ArrowLeft') navigatePrev();
        });

        nextButton.addEventListener('click', navigateNext);
        prevButton.addEventListener('click', navigatePrev);
    }
</script>
{% endblock %}