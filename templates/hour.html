{% extends "_base.html" %}

{% block title %}Análisis {{ display_day }} {{ hour }}{% endblock %}

{% block content %}
<div class="top-bar">
    <a href="{{ url_for('show_day', day=day) }}" class="csi-btn"><i class="fas fa-arrow-left me-2"></i>VOLVER AL DÍA</a>
    <a href="{{ url_for('logout') }}" class="csi-btn"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a>
</div>

<h2 class="csi-subtitle mb-4">
    ANALYZING EVIDENCE: {{ display_day }} - {{ hour }} <span class="text-info">{{ time_range }}</span>
</h2>

<div class="row g-3 row-cols-1 row-cols-sm-3 row-cols-md-5">  {% for img in images %}
    <div>  <div class="csi-panel">
            <img src="{{ url_for('serve_image_path', filepath=day+'/'+hour+'/'+img) }}" alt="Miniatura"
                 data-bs-toggle="modal" data-bs-target="#imageModal" data-index="{{ loop.index0 }}">
            <div class="csi-panel-title">
                <i class="fas fa-camera me-2"></i>
                {{ img.split('.')[0].replace('m','m ').replace('s','s') }}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<nav class="pagination-nav mt-5" aria-label="Navegación de imágenes">
    {% if page > 1 %}
        <a href="{{ url_for('show_hour', day=day, hour=hour, page=page-1) }}" class="csi-btn">
            <i class="fas fa-chevron-left me-2"></i> Anterior
        </a>
    {% else %}
        <span class="csi-btn disabled"><i class="fas fa-chevron-left me-2"></i> Anterior</span>
    {% endif %}

    <div class="page-numbers">
        {% set pages_to_show = 6 %}
        {% set start_page = (page - (pages_to_show // 2))|int %}
        {% if start_page < 1 %}{% set start_page = 1 %}{% endif %}
        {% set end_page = start_page + pages_to_show - 1 %}
        {% if end_page > total_pages %}
            {% set end_page = total_pages %}
            {% set start_page = (total_pages - pages_to_show + 1) if (total_pages - pages_to_show + 1) > 0 else 1 %}
        {% endif %}

        {% for p in range(start_page, end_page + 1) %}
            <a href="{{ url_for('show_hour', day=day, hour=hour, page=p) }}" 
            class="csi-btn {% if p == page %}active{% endif %}">
                {{ p }}
            </a>
        {% endfor %}
    </div>

    {% if page < total_pages %}
        <a href="{{ url_for('show_hour', day=day, hour=hour, page=page+1) }}" class="csi-btn">
            Siguiente <i class="fas fa-chevron-right ms-2"></i>
        </a>
    {% else %}
        <span class="csi-btn disabled">Siguiente <i class="fas fa-chevron-right ms-2"></i></span>
    {% endif %}
</nav>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" class="img-fluid" style="max-height: 85vh;" alt="Imagen ampliada">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const imagesOnCurrentPage = {{ images|tojson }};
    const imageBaseUrl = "{{ url_for('serve_image_path', filepath=day+'/'+hour) }}/";
    const imageModal = document.getElementById('imageModal');

    if (imageModal) {
        const modalTitle = imageModal.querySelector('.modal-title');
        const modalImage = imageModal.querySelector('.modal-body img');
        let currentIndexInPage = 0;

        function formatName(name) {
            return name.replace('.jpg','').replace('m','m ').replace('s','s');
        }

        function updateModal(indexInPage) {
            if (indexInPage < 0 || indexInPage >= imagesOnCurrentPage.length) return;
            currentIndexInPage = indexInPage;
            const imageName = imagesOnCurrentPage[indexInPage];
            modalTitle.textContent = `[ ${formatName(imageName)} ]`;
            modalImage.src = imageBaseUrl + imageName;
        }

        imageModal.addEventListener('show.bs.modal', event => {
            const index = parseInt(event.relatedTarget.getAttribute('data-index'));
            updateModal(index);
        });

        document.addEventListener('keydown', (event) => {
            if (!imageModal.classList.contains('show')) return;
            if (event.key === 'ArrowRight') {
                updateModal((currentIndexInPage + 1) % imagesOnCurrentPage.length);
            } else if (event.key === 'ArrowLeft') {
                updateModal((currentIndexInPage - 1 + imagesOnCurrentPage.length) % imagesOnCurrentPage.length);
            }
        });
    }
</script>
{% endblock %}
